---
title: "MERS-CoV Korea 2015 - Marta Smith"
output:
  pdf_document: default
  html_document: default
date: "2025-12-01"
geometry: margin=2cm
editor_options:
  chunk_output_type: inline
---

# Introduction

In this R Markdown, I analyze the `mers_korea_2015` dataset from the "outbreaks" R package and answer questions about the MERS-CoV outbreak in South Korea in 2015. Source: <https://github.com/luisfmontemayor/learn-compbio/tree/main>

```{r setup, include=FALSE}
# Loading the necessary packages
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2) # ggplot()
library(outbreaks) # data(mers_korea_2015)
library(forcats) # to use fct_infreq
library(lubridate) # to extract weeks from dates
library(tinytex)
library(knitr) 
library(psych)
library(naniar)

# Chunk setting:
knitr::opts_chunk$set(
  # Fig size
  fig.width = 5,          
  fig.height = 3.5,
  out.width = '70%',
  
  # Fig output
  fig.pos = 'h',          # 'here'
  out.extra = '',
  
  # Optional settings
  echo = TRUE,            
  warning = FALSE, 
  message = FALSE 
)
```

## Loading and inspecting the data

```{r}
# loading the data
data("mers_korea_2015")
```

### Quick questions

1.  What object class is `mers_korea_2015` in R?

`mers_korea_2015` is a list. A list is a collection of data which is ordered and changeable (source: <https://www.w3schools.com/r/r_lists.asp>).

2.  What sub-items exist within this item?

It contains 2 sub-items that are dataframes: `linelist` and `contacts`. `linelist`: A dataframe of MERS-CoV cases and their attributes. `contacts`: A dataframe describing the relationship between MERS Co-V cases (source: <https://www.rdocumentation.org/packages/outbreaks/versions/1.1.0/topics/mers.korea.2015>).

```{r results='hold'}
# inspecting the raw data
class(mers_korea_2015)
class(mers_korea_2015$linelist)
class(mers_korea_2015$contacts)
```

```{r}
length(mers_korea_2015) # number of elements the list contains
names(mers_korea_2015) # names of the elements of the list
str(mers_korea_2015) # structure function
```

3.  How can one access the sub-items within the `mers_korea_2015`?

```{r results='hide', include=FALSE}
# separating the data sets
# different ways of accessing the sub-items: either with a $ or [1]
mers_korea_2015$linelist
mers_korea_2015[1]


# cleaning the contacts
contacts <-mers_korea_2015$contacts %>%
  mutate(
    lag_contacts = as.numeric(diff_dt_onset) )
```

4.  The "sub-items" within `mers_korea_2015` are different data sets within our project. Play with them! Open them, plot graphs, get your hands dirty. The questions won't always tell you what data set to use! So know what you're starting with, to make sure that you can

```{r}
# exploring the linelist
linelist <- mers_korea_2015$linelist

linelist <- linelist %>%
  mutate(
    loc_hosp = str_replace(
      string = loc_hosp,
      pattern = ",.*",
      replacement = ""
    ) ) %>%
  mutate(
    loc_hosp = str_trim(loc_hosp),
    week = week(dt_report),
    lag_linelist = as.numeric(dt_report - dt_onset)
  )

# library(naniar) to check the missing values in the dataset
n_miss(linelist)
pct_miss(linelist)

linelist %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), 
               names_to = "variable", 
               values_to = "NA_count")

# NA distribution and percentage
linelist %>%
  vis_miss() +
  theme(axis.text.x = element_text(vjust = 0) )
```

```{r}
describe(linelist)
describe(contacts)

quantile(linelist$lag_linelist, na.rm=TRUE)
quantile(contacts$lag_contacts, na.rm=TRUE)
```

# Analyses

## Getting my hands dirty with the data

```{r results='hide'}
# admissions by the week number
admissions_by_week <- ggplot(linelist) + 
  geom_bar(aes(x=week), fill="gray", color="black") +
  theme_minimal() +
  labs(
    title="MERS admissions by week",
    x="Week",
    y="Admissions"
  )
admissions_by_week

# admissions by date of report
admissions_by_dt_report <- ggplot(linelist) + 
  geom_bar(aes(x=dt_report), fill="gray", color="black") + # color is used for the outline
  theme_minimal() +
  labs(
    title="MERS admissions by date of report",
    x="Date of Report",
    y="Admissions"
  )
admissions_by_dt_report

# admissions grouped by sex and date of report
admissions_summary <- linelist %>%
  group_by(week, sex) %>%
  summarise(
    count = n(),
    mean_age = mean(age, na.rm= TRUE),
    .groups = 'drop'
  )
admissions_summary

admissions_by_sex <- ggplot(admissions_summary, aes(x=week, y=count, color=sex)) +
  geom_line(linewidth=1) + geom_point(size=2) + theme_minimal() +
  labs(x="Week", y="Cases")
admissions_by_sex

# Mean Age of infected per week and sex
ggplot(admissions_summary, aes(x=week, y=mean_age, color=sex)) +
  geom_line(linewidth=1) + geom_point(size=2) + theme_minimal() +
  labs(x="Week", y="Mean Age of Infected")



# first approach to understand the average age of the two populations
age_by_outcome <- ggplot(linelist) + 
  geom_violin(aes(x=outcome, y=age, fill=outcome)) + 
  theme_minimal() +
  labs(title="",
       x="Outcome", y="Age",fill="Outcome")
age_by_outcome
```

## 1. Demographics

1.  Calculate the average age for patients with the outcome "Dead" and patients with the outcome "Alive."

Average ages: Dead: 68 years old; Alive: 53.6 years old. The average age of this sample was 55 years old.

```{r}
# age distribution (not grouped)
age_stats <- linelist %>%
  summarise(
    count = n(),
    mean_age = mean(age, na.rm= TRUE),
    median_age = median(age, na.rm = TRUE),
    sd_age = sd(age, na.rm = TRUE),
    .groups = 'drop'
  )
age_stats

# summary table (grouped by outcome)
outcome_stats <- linelist %>%
  group_by(outcome) %>%
  summarise(
    count = n(),
    mean_age = mean(age, na.rm= TRUE),
    median_age = median(age, na.rm = TRUE),
    sd_age = sd(age, na.rm = TRUE),
    .groups = 'drop'
  )
outcome_stats

# ggplot for the average age of the two populations
age_by_outcome <- ggplot(linelist) + 
  geom_boxplot(aes(x=outcome, y=age, fill=outcome)) + 
  theme_minimal() +
  labs(title="",
       x="Outcome", y="Age",fill="Outcome")
age_by_outcome

# Age histogram + normal distribution + mean age
age_histogram <- ggplot(linelist) +
  geom_histogram(
    aes(x = age, y = after_stat(density)), # y = density for overlay
    binwidth = 5, fill = "skyblue", color = "white", alpha = 0.7 ) +
  geom_density(
    aes(x = age),
    color = "red", 
    linewidth = 1,
    adjust = 2
  ) +
  geom_vline( # Average age as vertical line
    xintercept = age_stats$mean_age,
    color = "darkgreen",
    linetype = "dashed",
    linewidth = 1 ) +
  theme_minimal()
age_histogram
```

2.  Based on first impressions, does age seem to be a determinant of mortality in this outbreak? How might the social status of the elderly in South Korea contribute to exposure risks (e.g., care homes, hospital frequency)?

In South Korea, the elderly population is comprised of individuals aged 65 and older ([https://en.wikipedia.org/wiki/Aging_of_South_Korea](https://en.wikipedia.org/wiki/Aging_of_South_Korea#){.uri}). In this dataset, 49 of the cases are ages 65 and older (30% of the dataset).

Age seemed to be a determinant of mortality during the MERS-CoV outbreak in South Korea. The deceased group represents 11.7% of the dataset. The average age of the Dead group is 68 years old, 14.4 years higher than the Alive group (53.6). Also, the standard deviation for the Dead group is 56% lower in the Dead group with respect to the Alive group (8.9 vs 15.8). This shows that the data points in the Dead group are closer to the mean.

Analyzing the types of exposures in this outbreak, 47% of all infections came from Hospital Room visits (27%) and Emergency Rooms (20%). "The index case was a returning traveler from the Middle East. The infection had spread within the hospital, and subsequently to other hospitals because of patient movement, resulting in nosocomial transmission at 16 clinics and hospitals." (Source: <https://pmc.ncbi.nlm.nih.gov/articles/PMC5840604/>).

```{r}
hospital_count <- linelist %>%
  group_by(loc_hosp) %>%
  summarise(
    count = n(),
    percentage = count / nrow(linelist) * 100,
    mean_age = mean(age, na.rm= TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(count))
head(hospital_count)

exposure_count <- contacts %>%
  group_by(exposure) %>%
  summarise(
    count = n(),
    percentage = count / nrow(linelist) * 100,
    .groups = 'drop'
  ) %>%
  arrange(desc(count))
head(exposure_count)
  
hospital_dist <- linelist %>%
  rename(to = id) %>%
  left_join(contacts, by="to") %>%
  rename(id = to) %>%
  group_by(loc_hosp, exposure) %>%
  summarise(
    count = n(),
    percentage = count / nrow(linelist) * 100,
    mean_age = mean(age, na.rm=TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(count))
head(hospital_dist)

ggplot(hospital_dist, aes(x = fct_infreq(loc_hosp), y = count, fill=exposure)) +
  geom_bar(stat="identity", position="dodge") +
  labs (
    x="Hospital",
    y="Exposures",
    fill = "Types of Exposures"
  ) +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

3.  Name two social factors or behaviours you would expect from the sampled demographic that would increase the likelihood of exposure to MERS-CoV (particularly for the elderly population). An example could be "hospital hopping" where patients visit multiple hospitals to see different medical professionals.

The main hospitals where MERS-CoV spread were Samsung Medical Center (52.5%) and Pyeongtaek St. Mary’s Hospital (PTSM) (22.8%). These two hospitals accounted for 74% of all infections. In the case of the elderly population (49 cases), 20 of them were infected at Samsung Medical Center.

Hospital Room visits where family members and HCW could come and go could increase the likelihood of exposure to MERS-CoV. Another behavior that could increase the likelihood of becoming exposed would be to go to the emergency room for another medical condition.

```{r}
# understanding the elderly population's behavior
elderly <- linelist %>%
  filter(age >= 65)
nrow(elderly)

hospital_elderly <- elderly %>%
  group_by(loc_hosp) %>%
  summarise(
    count = n(),
    percentage = count / nrow(linelist) * 100,
    mean_age = mean(age, na.rm= TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(count))
head(hospital_elderly)

elderly_dist <- ggplot(elderly) + 
  geom_histogram(aes(x=age, fill=sex), binwidth=5) +
  labs(
    x="Age",
    y="Frequency",
    fill="Sex"
  ) +
  geom_vline( # Average age as vertical line
    xintercept = mean(elderly$age),
    color = "darkgreen",
    linetype = "dashed",
    linewidth = 1 ) +
  theme_minimal()
elderly_dist

# distribution across hospitals (elderly)
ggplot(elderly) + 
  geom_bar(
    aes(x = fct_infreq(loc_hosp) ),
    fill = "lightblue" ) +
  labs(
    title = "Frequency count of elderly",
    x = "Local hospital",
    y = ""
  ) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # changing the text's angle
```

4.  Synthesize your statistical finding with your identified social factors and behaviours to explain how **social status and norms** acted as an **amplifier** of the biological risk posed by age. Maybe it's a good time to look into Korean culture too!

```{r}

```

5.  Repeat task (d) but with the following points: saturated emergency rooms and family caregiving, common in Korea, where there is a cultural expectation for family members (usually younger women or older teens) to stay in the patient's room providing simple emotional and practical support.

```{r}
exposures <- contacts %>%
  group_by(exposure) %>%
  summarise (
    count = n(),
    percentage = count / nrow(linelist) * 100) %>%
  arrange(desc(count))
head(exposures)

exposure_types <- ggplot(contacts) + 
  geom_bar(aes(x = fct_infreq(exposure)), fill="lightgreen") +
  labs(
    x="Exposure Type",
    y="Cases" ) + 
  theme_minimal() + theme(axis.text.x = element_text(angle = 30, hjust = 1))
exposure_types
```

## **2. Institutional Analysis**

1.  Calculate the median reporting lag from the original variables provided. On average, how many days were people sick and potentially interacting with their social networks before the institution 'captured' them?

On a first approach, the median reporting lag in the `linelist` dataset is 5 days while the median lag in the `contacts` dataset is 14 days. Digging deeper into the data, the primary cases of the `contacts` dataset represent 6.7% of the `linelist`, while the secondary cases represent 58%. Also, 16% of the cases from the `linelist` do not have an onset date.

For 5 days, cases were interacting with other people, potentially transmitting MERS-CoV. SK_1, one of the super-spreaders and responsible for 26 infections, had a lag of 16 days between the onset of symptoms and their report.

The reporting lag of the `contacts` dataset is nearly 3 times higher than the `linelist`. This suggests that the secondary cases took longer to trace and report.

```{r}
# to see the number of onset dates that are missing
no_onset_date <- linelist %>%
  summarise(
    count = n(),
    yes_dt_onset = sum(!is.na(dt_onset)),
    no_dt_onset = sum(is.na(dt_onset)),
    percentage = (no_dt_onset / count) * 100
  )
no_onset_date

median_contacts <- median(contacts$diff_dt_onset)
median_linelist <- median(as.numeric(linelist$dt_report - linelist$dt_onset), na.rm=TRUE)
```

```{r results='hold'}
median_contacts
median_linelist

# difference between both datasets
median_contacts - median_linelist
```

```{r results='hold'}
# what is the proportion of the contacts dataset
n_distinct(contacts$from) / nrow(linelist) * 100 # primary cases
n_distinct(contacts$to) / nrow(linelist) * 100 # secondary cases
```

```{r}
# all lag observations across linelist and contacts
lag_comparison <- data.frame(
  delay = c(linelist$lag_linelist, 
            contacts$lag_contacts),
  dataset = c(rep("Linelist", nrow(linelist)), 
             rep("Contacts", nrow(contacts)))
)

# comparing the delay distributions across datasets
ggplot(lag_comparison, aes(x = delay, fill = dataset)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Lag Reporting Distribution",
       x="Delay between onset and report",
       y="Density",
       fill="Dataset")

# comparing the median reporting lags across datasets
ggplot(lag_comparison, aes(x = dataset, y = delay, fill = dataset)) +
  geom_boxplot(alpha = 0.7) +
  stat_summary(fun = median, geom = "label", aes(label = after_stat(y)), vjust = 0.5) +
  theme_minimal() +
  labs(title = "Median Reporting Lag: Linelist vs Contact Chain",
       y = "Days between onset and report",
       x = "") +
  guides(fill = "none")
```

2.  Analyse your new variable as a function of time. What does the trend tell you about the institution's ability to 'learn' and mobilize resources over time?

In week 22, the median reporting lag between the onset of symptoms and the report was the highest recorded (8 days). After week 22, the Korea CDC learned and the cases reported in weeks 23 and 24 decreased their lags to 5 and 4 days respectively.

```{r include=FALSE}
# median reporting lag as a time variable
median_reporting <- linelist %>%
  rename(to = id) %>%
  left_join(contacts, by="to") %>%
  rename(id = to) %>%
  mutate (
    week = week(dt_report)) %>%
  filter(
    !is.na(lag_linelist)) %>%
  group_by(week) %>%
  summarise(
    median_lag_linelist = median(lag_linelist, na.rm = TRUE),
    median_lag_contacts = median(lag_contacts, na.rm = TRUE),
    .groups = 'drop')

# median lag across time
ggplot(median_reporting, aes(x=week, y=median_lag_linelist)) + 
  geom_line() + geom_point() + theme_minimal() +
  labs(x="Week number", y="Days between onset and report")

# analyzing different lags
lag_by_week_long <- median_reporting %>% 
  pivot_longer(
    cols = starts_with("median"),
    names_to = "lag_type",
    values_to = "values" )

ggplot(lag_by_week_long, 
       aes(x = week, 
           y = values, 
           color = lag_type,
           group = lag_type) ) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) + 
  labs(x="Week", y="Median Reporting Lag", color="Type of Lag")+ theme_minimal()
```

3.  In MERS-CoV outbreaks in the Middle East, men were infected much more often. In this South Korean outbreak, is there a gender imbalance? What could this imply about the gender demographics of caregiving in Korean hospitals?

In South Korea, men were infected 1.5 times higher than women.

```{r}
# looking up the gender distribution
gender_stats <- linelist %>%
  filter(
    place_infect != "Middle East"
  ) %>%
  group_by(place_infect, sex) %>%
  summarise(
    count = n(),
    percentage = count / nrow(linelist) * 100,
    median_age = median(age, na.rm = TRUE))
gender_stats

gender_ratio <- nrow(subset(linelist, sex =="M")) / nrow(subset(linelist, sex =="F"))
gender_ratio

# distribution by age and sex
ggplot(linelist, aes(x = age, fill = sex)) +
  geom_histogram(data = subset(linelist, sex == "F"), aes(y = ..count.. * -1)) +
  geom_histogram(data = subset(linelist, sex == "M"), aes(y = ..count..)) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Distribution by Age and Gender", y = "Cases", x="Age") +
  scale_y_continuous(labels = abs)
```

*Bonus* - investigate why there were more male than female cases in the middle east spread of MERS-CoV. Why would this not apply in Korea?

## **3. The Super-Spreader**

a)  Using the appropriate dataset, calculate the number of infections attributed to each case. Calculate the mean and the maximum of this variable. What is the ratio between the maximum "infector" and the average?

For this analysis, I will categorize the super-spreader as those ids that infected 5 or more other cases.

Based on the Contacts data set and the previous assumption, we can identify 10 spreaders in this outbreak, and 3 super-spreaders: SK_14, SK_1, and SK_16. These 3 super-spreaders are males with an average age of 35 years old and located in the Pyeongtaek St. Mary Hospital (PTSM).

The 3 super-spreaders were responsible for 85 infections (52%). The super-spreader infected 4 times more than the average spreaders.

```{r eval=FALSE, include=FALSE}
# to review!!
super_spreaders <- grouped_data %>%
  group_by(id) %>%
  summarise(
    n_contactos = n(),
    delay = first(diff_onset_report)
  ) %>%
  arrange(desc(n_contactos))

# ¿Hay correlación entre n_contactos y delay?
plot(super_spreaders$n_contactos, super_spreaders$delay)
```

```{r}
# count of infections caused by each spreader
all_cases <- nrow(linelist)

spreader_count <- contacts %>%
  group_by(from) %>%
  summarise(
    infections = n(),
    percentage_of_infections = infections / all_cases * 100,
    .groups = 'drop' ) %>%
  arrange(desc(infections))
head(spreader_count)

# how did these spreaders infect the other cases?
superspreaders <- contacts %>%
  group_by(from,
           exposure) %>%
  summarise(
    infections = n(),
    percentage_of_infections = infections / all_cases * 100,
    .groups = 'drop') %>%
  arrange(desc(infections))
head(superspreaders)
```

```{r}
# What is the ratio between the maximum "infector" and the average?
# formula for a ratio = max / average

# calculating the max
max_infector_count <- max(spreader_count$infections, na.rm = TRUE)
max_infector_count

# calculating the average
avg_spreader_count <- mean(spreader_count$infections, na.rm = TRUE)
avg_spreader_count

# calculating the ratio
ratio <- max_infector_count / avg_spreader_count
ratio
```

b)  Visualise the distribution of secondary cases. What does the shape of your plot imply about how "democratic" or "equal" disease transmission was in this specific sample?

```{r results='hide'}

```

c)  Summarise the demographic profile of the "super spreader" using both datasets. Based on where they were infected and their demographic profile, hypothesize a social reason why this specific individual had such a high number of secondary cases.

```{r}
# left join to dig deeper into the superspreaders' details
superspreaders_deep <- superspreaders %>%
  rename(id = from) %>%   # rename 'from' to 'id'
  left_join(linelist, by = "id") %>%
  select(id,
         age,
         age_class,
         sex,
         infections,
         percentage_of_infections,
         place_infect,
         reporting_ctry,
         exposure,
         loc_hosp,
         outcome) %>%
  filter(infections >= 5)
superspreaders_deep
```

*Bonus* - Test the "Pareto Principle" (the 20/80 rule) on this data. Calculate what percentage of the total infections were caused by the top 20% of infectors. Does this outbreak fit the rule?

# Appendix

## Infection Network

```{r fig.width=15, fig.height=10, out.width='100%'}
library(igraph)
links <- data.frame(
  source= contacts$from,
  target = contacts$to
)
network <- graph_from_data_frame(
  d=links,
  directed=F
)

plot(network,
     vertex.size = 10,
     vertex.label.cex = 0.5,
     vertex.color="lightblue")
```
